<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Finance Tracker v3 (Supabase)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body.dark-mode {
      background-color: #121212;
      color: white;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      min-height: 80px;
      font-size: 12px;
    }
    .calendar-day.income { background-color: #d4edda; }
    .calendar-day.expense { background-color: #f8d7da; }
  </style>
</head>
<body class="bg-light">
<div class="container my-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Finance Tracker</h2>
    <div>
      <button id="darkToggle" class="btn btn-sm btn-secondary">Dark Mode</button>
    </div>
  </div>

  <!-- Starting Balance -->
  <div class="mb-4">
    <h5>Starting Balance</h5>
    <input type="number" id="startingBalance" class="form-control w-25 d-inline" placeholder="Enter balance">
    <button class="btn btn-primary btn-sm" onclick="saveBalance()">Save</button>
  </div>

  <!-- Add Transaction -->
  <div class="card p-3 mb-4">
    <h5>Add Transaction</h5>
    <div class="row g-2">
      <div class="col-md-2">
        <select id="type" class="form-select">
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="category" class="form-select"></select>
      </div>
      <div class="col-md-2">
        <input type="number" id="amount" class="form-control" placeholder="Amount">
      </div>
      <div class="col-md-3">
        <input type="date" id="date" class="form-control">
      </div>
      <div class="col-md-2">
        <button class="btn btn-success w-100" onclick="addTransaction()">Add</button>
      </div>
    </div>
    <input type="text" id="note" class="form-control mt-2" placeholder="Notes (optional)">
  </div>

  <!-- Transactions List -->
  <div class="card p-3 mb-4">
    <h5>Transactions</h5>
    <ul id="transactionList" class="list-group"></ul>
  </div>

  <!-- Budgets -->
  <div class="card p-3 mb-4">
    <h5>Budgets</h5>
    <div id="budgetContainer"></div>
  </div>

  <!-- Charts -->
  <div class="card p-3 mb-4">
    <h5>Spending Insights</h5>
    <canvas id="pieChart" style="max-height:200px;"></canvas>
    <canvas id="barChart" style="max-height:200px;"></canvas>
  </div>

  <!-- Calendar -->
  <div class="card p-3 mb-4">
    <h5>Monthly Calendar</h5>
    <div id="calendar" class="calendar"></div>
  </div>

  <!-- Export -->
  <div class="card p-3">
    <button class="btn btn-outline-primary" onclick="exportCSV()">Export to CSV</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://bchophlaojqnabbqydsk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjaG9waGxhb2pxbmFiYnF5ZHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMDM3MjksImV4cCI6MjA3MTc3OTcyOX0.Qeebuu4RqlNq01JkxMlMoyFolSDRIx61ReKZSm0axq0"; // replace with your real anon key
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let user = null;
let categories = [];
let transactions = [];

// ðŸ”¹ Check login
(async () => {
  const { data: { user: loggedUser } } = await supabaseClient.auth.getUser();
  if (!loggedUser) {
    window.location.href = "login.html";
  } else {
    user = loggedUser;
    loadCategories();
    loadTransactions();
  }
})();

// ðŸ”¹ Logout
//document.getElementById("logoutBtn").addEventListener("click", async () => {
//  await supabaseClient.auth.signOut();
//  window.location.href = "login.html";
//});

// ðŸ”¹ Dark Mode
document.getElementById("darkToggle").addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
});

// ðŸ”¹ Load Categories
async function loadCategories() {
  let { data, error } = await supabaseClient
    .from("categories")
    .select("id, name, type")
    .or(`user_id.eq.${user.id},user_id.is.null`);
  if (error) { console.error(error); return; }
  categories = data;
  const select = document.getElementById("category");
  select.innerHTML = "";
  data.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat.id;
    opt.textContent = `${cat.name} (${cat.type})`;
    select.appendChild(opt);
  });
}

// ðŸ”¹ Add Transaction
async function addTransaction() {
  const type = document.getElementById("type").value;
  const categoryId = document.getElementById("category").value;
  const amount = parseFloat(document.getElementById("amount").value);
  const date = document.getElementById("date").value;
  const note = document.getElementById("note").value;
  if (!amount || !date) { alert("Enter amount and date"); return; }

  const { error } = await supabaseClient.from("transactions").insert([{
    user_id: user.id, type, category_id: categoryId,
    amount, date, notes: note
  }]);
  if (error) console.error("Insert error:", error.message);
  else {
    document.getElementById("amount").value = "";
    document.getElementById("note").value = "";
    loadTransactions();
  }
}

// ðŸ”¹ Load Transactions
async function loadTransactions() {
  const { data, error } = await supabaseClient
    .from("transactions")
    .select("id, date, amount, type, notes, categories(name)")
    .eq("user_id", user.id)
    .order("date", { ascending: false });

  if (error) { console.error(error); return; }
  transactions = data;
  renderTransactions();
  renderCharts();
  renderCalendar();
}

function renderTransactions() {
  const list = document.getElementById("transactionList");
  list.innerHTML = "";
  transactions.forEach(t => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between";
    li.innerHTML = `
      <span>${t.date} - ${t.categories?.name || 'Uncategorized'} (${t.type}) ${t.notes || ''}</span>
      <span class="${t.type === 'income' ? 'text-success' : 'text-danger'}">â‚¹${t.amount}</span>
    `;
    list.appendChild(li);
  });
}

// ðŸ”¹ Charts
function renderCharts() {
  const expenseData = {};
  transactions.filter(t => t.type === "expense").forEach(t => {
    let cat = t.categories?.name || "Other";
    expenseData[cat] = (expenseData[cat] || 0) + t.amount;
  });
  const ctxPie = document.getElementById("pieChart");
  new Chart(ctxPie, {
    type: 'pie',
    data: {
      labels: Object.keys(expenseData),
      datasets: [{ data: Object.values(expenseData) }]
    }
  });

  const weekly = {};
  transactions.forEach(t => {
    const week = new Date(t.date).getWeek();
    weekly[week] = (weekly[week] || 0) + (t.type === "expense" ? t.amount : 0);
  });
  const ctxBar = document.getElementById("barChart");
  new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: Object.keys(weekly),
      datasets: [{ label: "Weekly Spend", data: Object.values(weekly) }]
    }
  });
}
Date.prototype.getWeek = function() {
  const onejan = new Date(this.getFullYear(),0,1);
  return Math.ceil((((this - onejan) / 86400000) + onejan.getDay()+1)/7);
};

// ðŸ”¹ Calendar
function renderCalendar() {
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";
  const now = new Date();
  const year = now.getFullYear(), month = now.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();

  for (let i=0;i<firstDay;i++) cal.appendChild(document.createElement("div"));
  for (let d=1; d<=daysInMonth; d++) {
    const dayDiv = document.createElement("div");
    dayDiv.className = "calendar-day";
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const daily = transactions.filter(t => t.date === dateStr);
    let sum = daily.reduce((a,b)=>a+(b.type==="income"?b.amount:-b.amount),0);
    if (sum > 0) dayDiv.classList.add("income");
    if (sum < 0) dayDiv.classList.add("expense");
    dayDiv.innerHTML = `<strong>${d}</strong><br>${sum!==0?"â‚¹"+sum:""}`;
    cal.appendChild(dayDiv);
  }
}

// ðŸ”¹ Save Balance
async function saveBalance() {
  const val = parseFloat(document.getElementById("startingBalance").value);
  if (!val) { alert("Enter valid balance"); return; }
  const yearMonth = new Date().toISOString().slice(0,7);
  await supabaseClient.from("balances").upsert({
    user_id: user.id, year_month: yearMonth, starting_balance: val
  }, { onConflict: "user_id,year_month" });
  alert("Balance saved");
}

// ðŸ”¹ Export CSV
function exportCSV() {
  let csv = "Date,Type,Category,Amount,Notes\n";
  transactions.forEach(t => {
    csv += `${t.date},${t.type},${t.categories?.name||''},${t.amount},${t.notes||''}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "transactions.csv";
  a.click();
}
</script>
</body>
</html>
