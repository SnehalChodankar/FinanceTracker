<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yearly Overview ‚Äî Finance Tracker</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { background: var(--bs-body-bg); }
    [data-bs-theme="dark"] body { background-color:#121212; color:#f1f1f1; }
    [data-bs-theme="dark"] .card { background-color:#1f1f1f; color:#e2e2e2; }
  </style>
</head>
<body>
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-outline-secondary btn-sm" id="prevYear">‚¨Ö</button>
      <h3 class="mb-0" id="yearTitle">üìä Yearly Overview</h3>
      <button class="btn btn-outline-secondary btn-sm" id="nextYear">‚û°</button>
    </div>
    <div class="d-flex gap-2">
      <a href="finance_v3.html" class="btn btn-outline-primary btn-sm">‚¨Ö Monthly Tracker</a>
      <button class="btn btn-success btn-sm" id="exportBtn">‚¨á Export Yearly Summary</button>
      <button class="btn btn-outline-secondary btn-sm" id="darkToggleBtn">üåô Dark</button>
    </div>
  </div>


    <!-- Yearly Totals Cards -->
  <div class="row g-3 mb-4" id="yearlyCards">
    <!-- Cards will be injected by JS -->
  </div>


  <!-- Summary Table -->
  <div class="card p-3 mb-4">
    <h6>Yearly Summary (per month)</h6>
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Month</th>
            <th>Days</th>
            <th>Starting Balance</th>
            <th>Total Income</th>
            <th>Total Expenses</th>
            <th>Net Balance</th>
          </tr>
        </thead>
        <tbody id="summaryTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-3 mb-4">
    <div class="col-md-6"><div class="card p-3"><canvas id="lineChart"></canvas></div></div>
    <div class="col-md-6"><div class="card p-3"><canvas id="barChart"></canvas></div></div>
  </div>

  <!-- Category Insights -->
  <div class="row g-3">
    <div class="col-md-6"><div class="card p-3"><h6>Category Spend Breakdown</h6><canvas id="catPie"></canvas></div></div>
    <div class="col-md-6"><div class="card p-3"><h6>Category Trends (per month)</h6><canvas id="catBar"></canvas></div></div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const LS_KEY = 'ft_calendar_v4';
const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
let currentYear = new Date().getFullYear();

// Helper: days in month
function daysInMonth(month, year) {
  return new Date(year, month+1, 0).getDate();
}

function renderYearly(year){
  const store = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  const summaryData = [];
  const categoryTotals = {};
  const monthlyCategory = Array.from({length:12},()=>({}));

  // Collect data
  for (let m=0;m<12;m++) {
    const key = `${year}-${String(m+1).padStart(2,'0')}`;
    const data = store[key] || { startingBalance:0, transactions:[], budgets:{} };

    const income = (data.transactions||[]).filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const expense = (data.transactions||[]).filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    const balance = (data.startingBalance||0) + income - expense;

    (data.transactions||[]).filter(t=>t.type==='expense').forEach(t=>{
      categoryTotals[t.category] = (categoryTotals[t.category]||0)+t.amount;
      monthlyCategory[m][t.category] = (monthlyCategory[m][t.category]||0)+t.amount;
    });

    summaryData.push({
      month: monthNames[m],
      days: daysInMonth(m, year),
      start: data.startingBalance||0,
      income, expense, balance
    });
  }


  

  // Update title
  document.getElementById('yearTitle').textContent = `üìä Yearly Overview ‚Äî ${year}`;

    // Totals
  const totalIncome = summaryData.reduce((s,r)=>s+r.income,0);
  const totalExpense = summaryData.reduce((s,r)=>s+r.expense,0);
  const totalBalance = summaryData.reduce((s,r)=>s+r.balance,0);

    // Summary Cards
  const cardsDiv = document.getElementById('yearlyCards');
  cardsDiv.innerHTML = `
    <div class="col-md-4">
      <div class="card text-center shadow-sm border-0 p-3 bg-light">
        <h6 class="text-muted">Total Income</h6>
        <h4 class="text-success fw-bold">+‚Çπ${totalIncome}</h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center shadow-sm border-0 p-3 bg-light">
        <h6 class="text-muted">Total Expenses</h6>
        <h4 class="text-danger fw-bold">-‚Çπ${totalExpense}</h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center shadow-sm border-0 p-3 ${totalBalance>=0?'bg-success-subtle':'bg-danger-subtle'}">
        <h6 class="text-muted">Net Balance</h6>
        <h4 class="${totalBalance>=0?'text-success':'text-danger'} fw-bold">‚Çπ${totalBalance}</h4>
      </div>
    </div>
  `;


  // Table body
  const tableBody = document.getElementById('summaryTable');
  tableBody.innerHTML='';
  summaryData.forEach(r=>{
    tableBody.innerHTML+=`
      <tr>
        <td>${r.month}</td>
        <td>${r.days}</td>
        <td>‚Çπ${r.start}</td>
        <td class="text-success">+‚Çπ${r.income}</td>
        <td class="text-danger">-‚Çπ${r.expense}</td>
        <td class="${r.balance>=0?'text-success':'text-danger'} fw-bold">‚Çπ${r.balance}</td>
      </tr>`;
  });

  // Totals row
  tableBody.innerHTML+=`
    <tr class="table-secondary fw-bold">
      <td>Total</td>
      <td>-</td>
      <td>-</td>
      <td class="text-success">+‚Çπ${totalIncome}</td>
      <td class="text-danger">-‚Çπ${totalExpense}</td>
      <td class="${totalBalance>=0?'text-success':'text-danger'}">‚Çπ${totalBalance}</td>
    </tr>`;


  

  // Destroy old charts before re-render
  Chart.helpers.each(Chart.instances, function(instance) { instance.destroy(); });

  // Charts
  new Chart(document.getElementById('lineChart'),{
    type:'line',
    data:{labels:summaryData.map(r=>r.month),datasets:[{label:'Balance',data:summaryData.map(r=>r.balance),borderColor:'#6366f1',tension:0.3,fill:false}]}
  });
  new Chart(document.getElementById('barChart'),{
    type:'bar',
    data:{labels:summaryData.map(r=>r.month),datasets:[
      {label:'Income',data:summaryData.map(r=>r.income),backgroundColor:'#10b981'},
      {label:'Expense',data:summaryData.map(r=>r.expense),backgroundColor:'#ef4444'}
    ]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
  new Chart(document.getElementById('catPie'),{
    type:'pie',
    data:{labels:Object.keys(categoryTotals),datasets:[{data:Object.values(categoryTotals),backgroundColor:['#f87171','#fb923c','#facc15','#4ade80','#60a5fa','#a78bfa','#f472b6']}]}
  });
  const categories=Object.keys(categoryTotals);
  const datasets=categories.map((c,i)=>({
    label:c,
    data:monthlyCategory.map(m=>m[c]||0),
    backgroundColor:['#f87171','#fb923c','#facc15','#4ade80','#60a5fa','#a78bfa','#f472b6'][i%7]
  }));
  new Chart(document.getElementById('catBar'),{
    type:'bar',
    data:{labels:monthNames,datasets},
    options:{responsive:true,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}}
  });

  // Export
  document.getElementById('exportBtn').onclick=()=>{
    const wb=XLSX.utils.book_new();
    const ws1=XLSX.utils.json_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb,ws1,'Monthly Summary');
    const catArr=Object.entries(categoryTotals).map(([c,v])=>({Category:c,Spent:v}));
    const ws2=XLSX.utils.json_to_sheet(catArr);
    XLSX.utils.book_append_sheet(wb,ws2,'Category Totals');
    const ws3=XLSX.utils.json_to_sheet(monthlyCategory.map((c,i)=>({Month:monthNames[i],...c})));
    XLSX.utils.book_append_sheet(wb,ws3,'Category by Month');
    XLSX.writeFile(wb,`Yearly_Summary_${year}.xlsx`);
  };
}

// Year navigation
document.getElementById('prevYear').onclick=()=>{currentYear--;renderYearly(currentYear);}
document.getElementById('nextYear').onclick=()=>{currentYear++;renderYearly(currentYear);}

// Initial render
renderYearly(currentYear);




// Dark mode
const html=document.documentElement;const darkBtn=document.getElementById('darkToggleBtn');
if(localStorage.getItem('theme')==='dark'){html.setAttribute('data-bs-theme','dark');darkBtn.textContent='‚òÄÔ∏è Light';}
darkBtn.onclick=()=>{
  if(html.getAttribute('data-bs-theme')==='dark'){html.setAttribute('data-bs-theme','light');darkBtn.textContent='üåô Dark';localStorage.setItem('theme','light');}
  else{html.setAttribute('data-bs-theme','dark');darkBtn.textContent='‚òÄÔ∏è Light';localStorage.setItem('theme','dark');}
};
</script>
</body>
</html>
